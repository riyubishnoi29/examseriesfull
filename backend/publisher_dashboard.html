<!DOCTYPE html>
<html>

<head>
  <title>Publisher Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h2 {
      margin-bottom: 10px;
    }

    .card {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      background: #f9f9f9;
    }

    button {
      margin-top: 5px;
      padding: 6px 12px;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }

    .approve {
      background: #28a745;
      color: #fff;
    }

    .reject {
      background: #dc3545;
      color: #fff;
    }

    .approve:hover {
      background: #218838;
    }

    .reject:hover {
      background: #c82333;
    }
  </style>
</head>

<body>
  <h2>Welcome, PUBLISHER!</h2>
  <button onclick="logout()">Logout</button>

  <!-- ✅ Draft Questions -->
  <h3>Draft Questions for Review</h3>
  <div id="pendingQuestions"></div>

  <!-- ✅ Draft Mock Tests -->
  <h3>Draft Mock Tests for Review</h3>
  <div id="pendingMocks"></div>

  <script>
    const token = localStorage.getItem("adminToken");
    const role = localStorage.getItem("role");
    if (!token || role !== "publisher") {
      alert("Unauthorized! Please login again.");
      window.location.href = "admin_login.html";
    }

    // ✅ Fetch draft questions
    async function loadPendingQuestions() {
      try {
        const res = await fetch("https://rankyard.in/questions?status=draft", {
          headers: { "Authorization": `Bearer ${token}` }
        });

        const data = await res.json();
        const container = document.getElementById("pendingQuestions");
        container.innerHTML = "";

        if (!data.length) {
          container.innerHTML = "<p>No draft questions for review.</p>";
          return;
        }

        data.forEach(q => {
          const card = document.createElement("div");
          card.className = "card";
          const options = Array.isArray(q.options) ? q.options.join(", ") : q.options;
          card.innerHTML = `
            <p><b>Mock ID:</b> ${q.mock_id}</p>
            <p><b>Question:</b> ${q.question_text}</p>
            <p><b>Options:</b> ${options}</p>
            <p><b>Correct:</b> ${q.correct_answer}</p>
            <button class="approve" onclick="updateQuestionStatus(${q.id}, 'approved')">Approve</button>
            <button class="reject" onclick="updateQuestionStatus(${q.id}, 'rejected')">Reject</button>
          `;
          container.appendChild(card);
        });
      } catch (err) {
        alert("Error loading questions: " + err.message);
      }
    }

    // ✅ Approve/Reject Question
    async function updateQuestionStatus(questionId, status) {
      try {
        const res = await fetch(`https://rankyard.in/questions/${questionId}/status`, {
          method: "PATCH",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ status })
        });

        const result = await res.json();
        alert(result.message || `Question ${status}!`);
        loadPendingQuestions();
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    // ✅ Fetch draft mocks
    async function loadPendingMocks() {
      try {
        const res = await fetch("https://rankyard.in/mock_tests?status=draft", {
          headers: { "Authorization": `Bearer ${token}` }
        });

        const data = await res.json();
        const container = document.getElementById("pendingMocks");
        container.innerHTML = "";

        if (!data.length) {
          container.innerHTML = "<p>No draft mock tests for review.</p>";
          return;
        }

        data.forEach(m => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <p><b>Exam ID:</b> ${m.exam_id}</p>
            <p><b>Title:</b> ${m.title}</p>
            <p><b>Duration:</b> ${m.duration_minutes} mins</p>
            <p><b>Difficulty:</b> ${m.difficulty}</p>
            <p><b>Total Marks:</b> ${m.total_marks}</p>
            <p><b>Negative Marking:</b> ${m.negative_marking ?? 0}</p>
            <button class="approve" onclick="updateMockStatus(${m.id}, 'live')">Publish</button>
            <button class="reject" onclick="updateMockStatus(${m.id}, 'rejected')">Reject</button>
          `;
          container.appendChild(card);
        });
      } catch (err) {
        alert("Error loading mocks: " + err.message);
      }
    }

    // ✅ Approve/Reject Mock
    async function updateMockStatus(mockId, status) {
      try {
        const res = await fetch(`https://rankyard.in/mock_tests/${mockId}`, {
          method: "PATCH",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ status })
        });

        const result = await res.json();
        alert(result.message || `Mock Test ${status}!`);
        loadPendingMocks();
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    function logout() {
      localStorage.clear();
      window.location.href = "admin_login.html";
    }

    // Load drafts on page load
    loadPendingQuestions();
    loadPendingMocks();
  </script>
</body>

</html>
